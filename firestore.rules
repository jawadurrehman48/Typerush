/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for sensitive user data
 * and a public-read/owner-write model for shared, competitive data. The primary goal is to
 * protect user privacy while enabling public features like leaderboards.
 *
 * Data Structure:
 * - /users/{userId}: Contains private UserProfile documents, keyed by the user's auth UID.
 * - /leaderboard/{leaderboardEntryId}: A global collection of all game scores, designed for
 *   public consumption.
 *
 * Key Security Decisions:
 * - User Enumeration is Disallowed: The top-level `/users` collection is not listable,
 *   preventing malicious actors from scraping all user profiles.
 * - Strict Profile Ownership: A user can only access and modify their own document within
 *   the `/users` collection.
 * - Public Leaderboard: The `/leaderboard` collection is publicly readable by anyone, including
 *   unauthenticated guests, to allow for displaying high scores.
 * - Leaderboard Integrity: Users can only create, update, or delete leaderboard entries that
 *   belong to them, enforced by checking a `userId` field on each entry.
 *
 * Denormalization for Authorization:
 * - The `LeaderboardEntry` document contains a `userId` field. This is a deliberate design
 *   choice that allows security rules to verify ownership for write operations without needing
 *   a slow and costly `get()` call to another document. This makes the rules faster and more
 *   secure.
 *
 * Structural Segregation:
 * - Private data (`UserProfile`) and public data (`LeaderboardEntry`) are stored in separate
 *   top-level collections. This is a best practice that simplifies rules for list operations
 *   and improves query performance and security, preventing accidental exposure of private data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //----------------------------------------------------------------//
    //                        Helper Functions                        //
    //----------------------------------------------------------------//

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A robust check for state-changing operations (update, delete).
     * It verifies ownership AND ensures the document actually exists.
     */
    function isExistingOwner(ownerId) {
      return isOwner(ownerId) && resource != null;
    }

    /**
     * Validates a new UserProfile document.
     * In Prototyping Mode, we only validate fields essential for authorization and relational integrity.
     * This ensures the document's internal `id` matches the document's path ID (`userId`).
     */
    function isCreatingValidUserProfile(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates an update to a UserProfile document.
     * Enforces immutability on the core `id` field to prevent re-linking the profile.
     */
    function isUpdatingValidUserProfile() {
      // The internal `id` field must not be changed after creation.
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates a new LeaderboardEntry document.
     * Ensures the entry's `userId` field correctly points to the person creating it.
     */
    function isCreatingValidLeaderboardEntry() {
      return request.resource.data.userId == request.auth.uid;
    }

    /**
     * Validates an update to a LeaderboardEntry document.
     * Enforces immutability on the `userId` field to prevent re-assigning scores.
     */
    function isUpdatingValidLeaderboardEntry() {
      // The `userId` cannot be changed after the score has been posted.
      return request.resource.data.userId == resource.data.userId;
    }

    //----------------------------------------------------------------//
    //                       Collection Rules                         //
    //----------------------------------------------------------------//

    /**
     * @description Controls access to private user profile data. Only the document owner can
     *              read or write their own profile. Listing all users is forbidden.
     * @path        /users/{userId}
     * @allow       (get, update) - An authenticated user ('user_abc') can read and update their own profile at `/users/user_abc`.
     * @deny        (get) - User 'user_abc' cannot get the profile at `/users/user_xyz`.
     * @deny        (list) - No user, authenticated or not, can list the `/users` collection.
     * @principle   Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingValidUserProfile(userId);
      allow update: if isExistingOwner(userId) && isUpdatingValidUserProfile();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to the public leaderboard. The collection is readable by
     *              anyone, but entries can only be created, updated, or deleted by the user
     *              who achieved the score.
     * @path        /leaderboard/{leaderboardEntryId}
     * @allow       (get, list) - Any user, including unauthenticated guests, can read any leaderboard entry or list the entire collection.
     * @allow       (create) - An authenticated user ('user_abc') can create a new leaderboard entry as long as its `userId` field is 'user_abc'.
     * @deny        (create) - User 'user_abc' cannot create an entry with a `userId` of 'user_xyz'.
     * @deny        (update) - User 'user_abc' cannot update an existing entry where `resource.data.userId` is 'user_xyz'.
     * @principle   Enables public-read access while enforcing document ownership for all write operations.
     */
    match /leaderboard/{leaderboardEntryId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isCreatingValidLeaderboardEntry();
      allow update: if isExistingOwner(resource.data.userId) && isUpdatingValidLeaderboardEntry();
      allow delete: if isExistingOwner(resource.data.userId);
    }
  }
}
